
1. # **需求背景**

在公司大促活动期间，系统面临高并发压力，为保障线上系统稳定性，需要临时禁止所有用户使用压测平台（Kmeter和PTS）进行压测活动，包括测试环境和生产环境。

2. # ** 需求描述**

开发接口支持一键禁用/启用指定用户或所有用户在特定时间内使用PTS和Kmeter平台的压测权限（包括生产环境和预发布环境）。

3. # **解决方案**

通过修改用户的压测执行权限，在指定时间段内限制压测活动的进行。具体实现针对两个平台采用不同的技术手段：

**-** Kmeter平台：修改数据库权限标识

**-** PTS平台：利用阿里云RAM权限策略管理

4. # **实现方案**
5. ## **Kmeter 平台**
6. ### **权限控制**

Kmeter 测试和产线环境都是通过 同一个 DB  user 表的 is_super 字段来管理压测可执行权限，

其中，is_super 为 1 表示可执行压测，为 0 表示禁止压测。

```SQL
-- 修改用户表权限字段
UPDATE user SET is_super = 0 WHERE email IN (用户邮箱列表);
-- 0: 禁用压测权限
-- 1: 启用压测权限
```

因此，在大促活动开始前，禁止所有用户使用 kmeter 压测，可以通过执行下面的命令完成禁止压测功能

```Plain
update user set is_super = 0 where is_super =1;
```

在大促活动结束后，恢复所有用户到大促前的压测使用权限，可以通过执行下面的命令完成禁止压测功能

```Plain
update user set is_super = 1 where email in (kmeter_super_emails);
```

这里的 kmeter_super_emails 是在大促活动开始前，提前换成到 redis 中的所有可执行压测权限的用户邮箱列表。

2. ### 流程图
3. ### **接口设计**

`URL: /kmeter/permission_control`

`method: post`

`请求参数:`

`user_list: []string, 非必填`

`enable: true|false, 默认为 false`

实现逻辑描述

```SQL
对 user 表的 is_super 字段(0: 禁用， 1: 使能)进行更新，更新逻辑为:
1. 如果 req.UserList 为空且 req.Enable 为 false，则将当前 user 表中所有 is_super 为 1 的 email 写入 redis(key: kmeter_super_emails, value: email 列表), 然后再将 user 所有用户的 is_super 字段设置为 0;
如：
update user SET is_super = 0;

2. 如果 req.UserList 为空且 req.Enable 为 true，则读取 redis (kmeter_super_emails), 然后根据读取的 kmeter_super_emails 更新 user 表 is_super 字段为 1;
如：（伪代码）
update user SET is_super = 1 WHERE email in (kmeter_super_emails);

3. 如果 req.UserList 非空(用户邮箱列表)且 req.Enable 为 false，则直接更新满足 email 在 req.UserList 中的所有 
user 所有用户的 is_super 字段设置为 0; 
如：（伪代码）
update user SET is_super = 0 WHERE email in (req.UserList);

4. 如果 req.UserList 非空(用户邮箱列表)且 req.Enable 为 true，则直接更新满足 email 在 req.UserList 中的所有 
user 所有用户的 is_super 字段设置为 1; 
如：（伪代码）
update user SET is_super = 1 WHERE email in (req.UserList);
```

2. ## **PTS 平台**
3. ### **权限控制**

#### **准备阶段（一次性操作）**

* 创建公共管理账号 或 申请 accessKey
* 申请 RAM 相关权限
* 创建自定义权限策略(禁用压测)

#### 权限策略绑定与解绑

1. 大促活动开始前，调用 接口一键绑定自定义权限策略到所有用户
2. 大促活动结束后，调用 接口一键解绑自定义权限策略到所有用户
3. ### 流程图
4. ### 接口设计

`URL: /pts/permission_control`

`method: post`

`请求参数:`

`user_group: []string, 非必填, 为空取默认值`

`permissions_strategy: string, 非必填, 为空取默认值`

实现逻辑描述

1. 调用 pts 平台的 [CreatePolicy](https://help.aliyun.com/zh/ram/developer-reference/api-ram-2015-05-01-createpolicy?spm=a2c4g.11186623.0.0.c4367618DGytPV) 接口创建一个自定义的权限策略
2. 大促活动开始前，运维人员通过调用接口一键绑定自定义权限策略到所有用户
3. 大促活动结束后，运维人员通过调用接口一键解绑自定义权限策略到所有用户
